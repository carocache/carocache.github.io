<!doctype html>
<html>
	<head>
		<style>
			* {
				font-family: sans-serif;
			}
			
			#compass {
				font-size: 3em;
				text-align: center;
			}
			
			#comp {
				width: 100%;
				margin: auto;
			}
		</style>
	</head>
	<body>
		<h1 id="bearing">init</h1>
		<img id="comp" src="carocompass.png" />
		<script>
			let carocache = {
				lat: 34.721217,
				lon: -86.757800
			}
			
			compass = document.querySelector("#comp");
			bearing = document.querySelector("#bearing");
			
			mylat = 0;
			mylon = 0;
			
			
			navigator.geolocation.getCurrentPosition(function(pos) {
				mylat = pos.coords.latitude;
				mylon = pos.coords.longitude;
			});
			
			if (window.DeviceOrientationEvent) {
			  // Listen for the deviceorientation event and handle the raw data
			  window.addEventListener('deviceorientation', function(eventData) {
			    var compassdir;
			
			    if(event.webkitCompassHeading) {
			      // Apple works only with this, alpha doesn't work
			      compassdir = event.webkitCompassHeading;
			    }
			    else compassdir = event.alpha;
			    
			    compass.style.transform = "rotate(" + -compassdir + "deg)";
			    if (mylat != 0) bearing.textContent = getBearing(mylat, mylon, carocache.lat, carocache.lon).bearing;
			    
			  });
			}
			
			function getBearing(lat1, lon1, lat2, lon2) {
				var R = 6371e3; // metres
				var φ1 = lat1.toRadians();
				var φ2 = lat2.toRadians();
				var Δφ = (lat2-lat1).toRadians();
				var Δλ = (lon2-lon1).toRadians();
				
				var a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
				        Math.cos(φ1) * Math.cos(φ2) *
				        Math.sin(Δλ/2) * Math.sin(Δλ/2);
				var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
				
				var d = R * c;
				
				var y = Math.sin(λ2-λ1) * Math.cos(φ2);
				var x = Math.cos(φ1)*Math.sin(φ2) - Math.sin(φ1)*Math.cos(φ2)*Math.cos(λ2-λ1);
				var brng = Math.atan2(y, x).toDegrees();
				
				return {
					dist: d,
					bearing: brng
				};
			}
		</script>
	</body>
<!-- 	
	- waypoints
	- landmarks for navigation
	- distance
	- street names
	- google maps routing
	 -->
</html>