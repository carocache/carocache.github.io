<!doctype html>
<html>
	<head>
		<style>
			* {
				font-family: sans-serif;
			}
			
			#compass {
				font-size: 3em;
				text-align: center;
			}
			
			#comp {
				width: 100%;
				margin: auto;
			}
		</style>
	</head>
	<body>
		<h1 id="bearing">init</h1>
		<h2 id="lat">Lat: </h2>
		<h2 id="lon">Lon: </h2>
		<h2><span id="dist"></span>&nbsp;ft</h2>
		<img id="comp" src="carocompass.png" />
		<script>
			let carocache = {
				lat: 34.721217,
				lon: -86.757800
			}
			
			var compass = document.querySelector("#comp");
			var bearingEl = document.querySelector("#bearing");
			var latEl = document.querySelector("#lat");
			var lonEl = document.querySelector("#lon");
			var distEl = document.querySelector("#dist");
			
			var mylat;
			var mylon;
			
			var bearing;
			var distance;
			
			function updateLocation() {
				navigator.geolocation.getCurrentPosition(function(pos) {
					mylat = pos.coords.latitude;
					mylon = pos.coords.longitude;
				});
			}
			
			updateLocation();
			
			setTimeout(function() {
				getBearing(mylat, mylon, carocache.lat, carocache.lon);
				updateLocation();
			}, 500);
			
			if (window.DeviceOrientationEvent) {
			  // Listen for the deviceorientation event and handle the raw data
			  window.addEventListener('deviceorientation', function(eventData) {
			    var compassdir;
			
			    if(event.webkitCompassHeading) {
			      // Apple works only with this, alpha doesn't work
			      compassdir = event.webkitCompassHeading;
			    }
			    else compassdir = event.alpha;
			    
			    compass.style.transform = "rotate(" + (bearing - compassdir) + "deg)";
			    bearingEl.textContent = bearing;
			    latEl.textContent = mylat;
			    lonEl.textContent = mylon;
			    distEl.textContent = distance;
			  });
			}
			
			function degToRad(deg) {
				return deg/180 * Math.PI;
			}
			
			function getBearing(lat1, lon1, lat2, lon2) {
				var R = 6371e3; // metres
				var φ1 = degToRad(lat1);
				var φ2 = degToRad(lat2);
				var Δφ = degToRad(lat2-lat1);
				var Δλ = degToRad(lon2-lon1);
				
				var a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
				        Math.cos(φ1) * Math.cos(φ2) *
				        Math.sin(Δλ/2) * Math.sin(Δλ/2);
				var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
				
				var d = R * c * 3.28084;
				
				var y = Math.sin(lon2-lon1) * Math.cos(lat2);
				var x = Math.cos(lat1)*Math.sin(lat2) - Math.sin(lat1)*Math.cos(lat2)*Math.cos(lon2-lon1);
				var brng = -Math.atan2(y, x) / Math.PI * 180;
				
				bearing = brng;
				distance = d;
/*
				return {
					dist: d,
					bearing: brng
				};
*/
			}
		</script>
	</body>
<!-- 	
	- waypoints
	- landmarks for navigation
	- distance
	- street names
	- google maps routing
	 -->
</html>